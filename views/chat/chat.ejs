<style>
    #chatbox {
        /* border: 1px solid #ccc; */
        max-height: 50vh;
        /* Set a fixed height for the chatbox */
        overflow: auto;
        list-style: none;
        padding: 0;
    }

    .chat-message {
        font-size: 16px;
        max-width: auto;
        word-wrap: break-word;
        overflow-wrap: break-word;
        word-break: break-word;
    }

    /* SYSTEM MESSAGE */
    .system {
        max-width: 100%;
        background-color: #787878;
        border-radius: 20px;
        padding: 5px 20px;
        margin-bottom: 10px;
        color: #ffffff;
    }

    /* Your messages */
    .outgoing {
        max-width: 60%;
        background-color: #02c78f;
        border-radius: 20px;
        padding: 10px 0 10px 10px;
        margin-bottom: 5px;
        margin-left: auto;
        color: white;
    }

    /* Other messages */
    .incoming {
        max-width: 60%;
        background-color: #e9e9eb;
        border-radius: 20px;
        padding: 5px 10px;
        margin-bottom: 5px;
        text-align: left;
    }

    /* USERNAME */
    .chat-username {
        font-weight: bold;
    }

    .chat-form {
        display: flex;
        flex-direction: column;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 20px;
        text-align: left;
        position: relative;
    }

    .chat-input-container {
        display: flex;
        align-items: center;
    }

    .chat-text {
        width: 100%;
        /* height: 10vh; */
        border-radius: 20px;
        border: 1px solid #ced4da;
        padding: 10px;
        margin-bottom: 10px;
        margin-left: auto;
    }

    .delete-button {
        background-color: red;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 5px 10px;
        cursor: pointer;
    }

    .deleted-message {
        background-color: #cccccc;
    }

    .deleted-message .chat-username,
    .deleted-message .deleted-message-content {
        color: #888888;
    }
</style>


<script src="https://www.gstatic.com/firebasejs/8.7.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.7.0/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script> <!-- Add this line -->

<script src="/app.js"></script>
<script src="chat.js"></script>

<script>
    // Initialize Firebase
    var firebaseConfig = {
        databaseURL: "https://orcachat-896f1-default-rtdb.firebaseio.com/",
        apiKey: "AIzaSyCqohTy2xTnkLispHSq2TGRP2VDyhRcEB0",
        authDomain: "orcachat-896f1.firebaseapp.com",
        projectId: "orcachat-896f1",
        storageBucket: "orcachat-896f1.appspot.com",
        messagingSenderId: "1069412700995",
        appId: "1:1069412700995:web:c4b568bb2df7c9351055f6"
    };

    firebase.initializeApp(firebaseConfig);
</script>

<script>
    function sendMessage() {
        var messageInput = document.getElementById('message');
        var message = messageInput.value;

        // Check if the message is empty
        if (message === '') {
            return; // Return without sending the message
        }

        // Get the username from the session or any other source
        var username = "<%= user.username %>";

        // Generate a unique ID for the message
        var messageId = firebase.database().ref().child('PodChat23').push().key;

        // Save the message, username, and messageId to Firebase Realtime Database
        firebase.database().ref('PodChat23/' + messageId).set({
            messageId: messageId, // Add the messageId to the message object
            content: message,
            username: username,
            timestamp: Date.now()
        });

        // Clear the input field
        messageInput.value = '';

        // Add event listener for the Enter key press event
        document.getElementById('message').addEventListener('keyup', function (event) {
            if (event.keyCode === 13) {
                event.preventDefault();
                sendMessage();
            }
        });
    }

    function deleteMessage(message) {
        var messageId = message.messageId;

        // Display a confirmation modal
        var confirmDelete = confirm('Are you sure you want to delete this message?');
        if (!confirmDelete) {
            return; // Abort deletion if the user cancels
        }

        firebase
            .database()
            .ref('PodChat23/' + messageId)
            .remove()
            .then(() => {
                var messageElement = document.getElementById(messageId);
                messageElement.innerHTML = ''; // Clear the existing content

                var usernameElement = document.createElement('span');
                usernameElement.classList.add('chat-username');
                usernameElement.innerHTML = '@' + message.username + '<br>';
                messageElement.appendChild(usernameElement);

                var contentElement = document.createElement('span');
                contentElement.classList.add('deleted-message-content');
                contentElement.innerHTML = 'Deleted message';
                messageElement.appendChild(contentElement);

                messageElement.classList.add('deleted-message');
            })
            .catch((error) => {
                console.error('Error deleting message:', error);
            });
    }


    function displayMessage(message) {
        var listItem = document.createElement('li');
        var chatMessage = document.createElement('div');

        // Add the message to the list
        chatMessage.classList.add('chat-message');
        chatMessage.setAttribute('id', message.messageId);

        // Add the username and message content to the message
        if (message.username !== 'System') {
            var sender = document.createElement('span');
            sender.classList.add('chat-username');
            sender.innerHTML = '@' + message.username + '<br>';
            chatMessage.appendChild(sender);
        }
        if (message.username === "<%= user.username %>") {

            // Turn the message into an outgoing message
            chatMessage.classList.add('outgoing');

            // Add the delete button to the message
            var deleteButton = document.createElement('button');
            deleteButton.classList.add('delete-button');
            deleteButton.innerHTML = 'Delete';
            deleteButton.addEventListener('click', function () {
                deleteMessage(message);
            });
            chatMessage.appendChild(deleteButton);
        } else if (message.username === 'System') {

            // Turn the message into a system message
            chatMessage.classList.add('system');
        } else {

            // Turn the message into an incoming message
            chatMessage.classList.add('incoming');
        }

        var chatbox = document.getElementById('chatbox');
        var shouldScroll = chatbox.scrollTop + chatbox.clientHeight === chatbox.scrollHeight;

        var contentElement = document.createElement('span');
        contentElement.innerHTML = message.content;
        chatMessage.appendChild(contentElement);

        listItem.appendChild(chatMessage);

        chatbox.appendChild(listItem);

        if (shouldScroll) {
            chatbox.scrollTop = chatbox.scrollHeight;
        }
    }

    // Listen for changes in the Firebase Realtime Database
    firebase.database().ref('PodChat23').on('child_added', function (snapshot) {
        var message = snapshot.val();
        displayMessage(message);
    });

    function createNode() {
        // Get the current count of nodes
        firebase.database().ref('nodeCount').once('value')
            .then(snapshot => {
                var count = snapshot.val() || 0; // If no count exists, initialize it to 0
                count++; // Increment the count

                // Generate the node name
                var nodeName = 'PodChat' + count;

                // Update the count in the database
                firebase.database().ref('nodeCount').set(count)
                    .then(() => {
                        // Generate a unique push key for the messages object
                        var messagesKey = firebase.database().ref().child(nodeName).push().key;

                        // Create the new node in the database at the same level as "messages"
                        firebase.database().ref().child(nodeName).set({
                            // Use the push key as the key for the messages object
                            [messagesKey]: {
                                username: 'System',
                                content: 'Welcome to your new Pod Chat! Be nice to everyone :)',
                                timestamp: Date.now()
                            }
                        })
                            .then(() => {
                                console.log('New chat created successfully.');
                                console.log('New chat name:', nodeName); // Print the new chat name in the console
                            })
                            .catch(error => {
                                console.error('Error creating new node:', error);
                            });
                    })
                    .catch(error => {
                        console.error('Error updating node count:', error);
                    });
            })
            .catch(error => {
                console.error('Error retrieving node count:', error);
            });
    }
</script>

<%- include("../templates/header") %>

    <div>
        <div class="chat-form">
            <ul id="chatbox"></ul>
            <div>
                <input class="chat-text" type="text" id="message">
                <button class="blue-button btn" onclick="sendMessage()">Send</button>
                <button class="btn blue-button" onclick="createNode()">Create Node</button>
            </div>
        </div>
    </div>
    </div>
    <%- include("../templates/footer") %>